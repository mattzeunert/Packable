<app-nav
  [header]="'Packing List'"
  [useNgContent]="true">
  <button
    [matMenuTriggerFor]="packinglistMenu"
    type="button"
    (click)="null"
    mat-icon-button
    activeColor="action">
    <mat-icon outlined>settings</mat-icon>
  </button>
</app-nav>
<mat-menu #packinglistMenu="matMenu">
  <packinglist-settings></packinglist-settings>
</mat-menu>
<div class="row">
  <ng-template #loading>
    <div class="col">
      <i class="fas fa-sync-alt fa-spin"></i>
      Loading List...
    </div>
  </ng-template>
  <div
    *ngIf="packingList && sortedList; else loading"
    class="mt-1 col">
    <div class="row">
      <mat-accordion class="w-100">
        <mat-expansion-panel
          (opened)="settingsOpen = true"
          (closed)="settingsOpen = false"
          [expanded]="settingsOpen">
          <mat-expansion-panel-header>
            <mat-panel-description
              class="d-flex w-100"
              *ngIf="!settingsOpen">
              <span
                class="setting_header"
                [innerHtml]="forecastString">
              </span>
              <span
                class="setting_header"
                *ngIf="packingList.dataInput == 'manual'">
                (Manual Input)
              </span>
              <span class="setting_header ml-auto small">
                <i>Updated: {{ lastSave }}</i>
              </span>
            </mat-panel-description>
            <mat-panel-title *ngIf="settingsOpen">Manually enter weather settings</mat-panel-title>
          </mat-expansion-panel-header>
          <form [formGroup]="customWeatherForm">
            <mat-form-field style="width:110px;">
              <mat-label>Min Temp</mat-label>
              <mat-select
                [value]="packingList.data.weatherData.minTemp || absoluteMinTemp"
                formControlName="min"
                #minTempSelect>
                <mat-option
                  *ngFor="let t of tempOptions"
                  [value]="t"
                  [disabled]="t>maxTempSelect.value">
                  {{t!=absoluteMinTemp ? t+'&#176;C' : 'Any'}}
                </mat-option>
              </mat-select>
            </mat-form-field>
            <mat-form-field style="width:110px;">
              <mat-label>Max Temp</mat-label>
              <mat-select
                [value]="packingList.data.weatherData.maxTemp || absoluteMaxTemp"
                formControlName="max"
                #maxTempSelect>
                <mat-option
                  *ngFor="let t of tempOptions"
                  [value]="t"
                  [disabled]="minTempSelect.value>t">
                  {{t!=absoluteMaxTemp ? t+'&#176;C' : 'Any'}}
                </mat-option>
              </mat-select>
            </mat-form-field>
            <mat-form-field style="width:200px;">
              <mat-label>Weather Types</mat-label>
              <mat-select
                [value]="packingList.data.weatherData.weatherTypes || null"
                multiple
                formControlName="types">
                <mat-option
                  *ngFor="let w of weatherTypeOptions"
                  [value]="w">
                  {{w | titlecase}}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </form>
          <mat-action-row>
            <span class="p-2 align-self-center">
              <b>Update Using:</b>
            </span>
            <button
              type="button"
              class="btn btn-primary"
              (click)="updatePackingListWithCustomWeather(trip)"
              (click)="settingsOpen = false">
              Manual Input
            </button>
            <button
              type="button"
              class="btn btn-outline-primary ml-1"
              (click)="updatePackingListWithWeatherAPI(trip)"
              (click)="settingsOpen = false">
              Forecast
            </button>
          </mat-action-row>
        </mat-expansion-panel>
      </mat-accordion>
    </div>

    <div class="row py-2">
      <mat-accordion
        multi="true"
        class="w-100">
        <mat-expansion-panel
          *ngFor="let profile of sortedList; let i = index"
          [hideToggle]="true"
          [class.mat-elevation-z0]="windowService.max('sm')"
          [expanded]="windowService.min('sm')"
          [disabled]="windowService.min('sm')"
          #panel>
          <mat-expansion-panel-header>
            <mat-panel-title>
              <span
                class="mat-expansion-indicator"
                [class.expanded]="panel.expanded"
                *ngIf="!panel.disabled"></span>
              <div class="profileHeader">
                <profile-icon
                  [avatar]="profile.avatar"
                  [width]="windowService.max('sm') ? '40px' : '50px'"
                  [fullFrame]="!profile.id"></profile-icon>
                <h4 class="m-0 text-capitalize">{{profile.header}}</h4>
                <h4 class="m-1">
                  <mat-icon
                    [inline]="true"
                    class="completedTick"
                    *ngIf="isProfileChecked(profile)"
                    appColor="accent">
                    done_outline
                  </mat-icon>
                </h4>
              </div>
            </mat-panel-title>
            <mat-panel-description>
              {{countCompletedInProfile(profile)}} / {{countPackablesInProfile(profile)}}
            </mat-panel-description>
            <div
              class="profile-options"
              InnerLink>
              <button
                mat-icon-button
                [matMenuTriggerFor]="profileDropDown"
                title="Traveler List Options"
                activeColor="muted">
                <i class="material-icons">more_vert</i>
              </button>
              <mat-menu #profileDropDown="matMenu">
                <button mat-menu-item>
                  <mat-icon outlined>share</mat-icon>
                  <span>Share</span>
                </button>
                <button
                  mat-menu-item
                  (click)="tickAllProfile(profile)">
                  <mat-icon>done_all</mat-icon>
                  <span>Check All</span>
                </button>
                <button
                  mat-menu-item
                  (click)="resetAllProfile(profile)">
                  <mat-icon>replay</mat-icon>
                  <span>Reset List</span>
                </button>
              </mat-menu>
            </div>
          </mat-expansion-panel-header>
          <app-column-divider [cols]="windowService.max('sm') ? 1 : (windowService.max('xxl') ? 2 : 3)">
            <ng-container *ngFor="let collection of profile.collections">
              <packing-list-collection
                *ngIf="collection.validPackables() > 0 || packingListSettings.showInvalid"
                [listSettings]="packingListSettings"
                [(collection)]="collection"
                [trip]="trip"
                [(editingPackable)]="editingPackable">
              </packing-list-collection>
            </ng-container>
          </app-column-divider>
        </mat-expansion-panel>
      </mat-accordion>
    </div>
  </div>
</div>
